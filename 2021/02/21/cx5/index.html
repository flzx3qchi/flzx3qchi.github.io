<!DOCTYPE html>


<html lang="en" >


<head>
  <meta charset="utf-8" />
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
    操作系统真象还原&lt;第五部分&gt; |  Hexo
  </title>
  <meta name="generator" content="hexo-theme-yilia-plus">
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  
<link rel="stylesheet" href="/dist/main.css">

  
<link rel="stylesheet" href="/css/custom.css">

  
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
  
  

  

</head>

</html>

<body>
  <div id="app">
    <main class="content on">
      <section class="outer">
  <article id="post-cx5" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  操作系统真象还原&lt;第五部分&gt;
</h1>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2021/02/21/cx5/" class="article-date">
  <time datetime="2021-02-20T16:00:00.000Z" itemprop="datePublished">2021-02-21</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a>
  </div>

      
      
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> Word count:</span>
            <span class="post-count">10k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> Reading time≈</span>
            <span class="post-count">41 min</span>
        </span>
    </span>
</div>

      
    </div>
    

    
    
    <div class="tocbot"></div>





    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <p>(｡･∀･)ﾉﾞ嗨起来！！！</p>
<a id="more"></a>

<h1 id="中断"><a href="#中断" class="headerlink" title="中断"></a>中断</h1><h2 id="中断概念"><a href="#中断概念" class="headerlink" title="中断概念"></a>中断概念</h2><p>中断处理，就是处理器接受到中断信号后，暂停当前执行的任务，转而去查找中断向量表，去执行中断服务程序，执行完后，恢复到中断前的状态，继续执行刚才的程序。</p>
<p>形象一点就是有个人或有个急事打断你现在做的事情，让你不得不处理这件紧急的事情，当你处理完这件事情后（当然也有可能继续被另一件事情打断），再做回你刚才没做完的事情。</p>
<p>并发和并行的区别：</p>
<ol>
<li>单核cpu-并发：单位时间内的<strong>积累</strong>工作量，如在一秒内cpu处理了100个请求量</li>
<li>多核cpu-并行：真正同时进行的工作量，如在任意瞬间cpu正在同时处理100个请求量</li>
</ol>
<p>系统有了中断，才能够并发运行，能够不断的切换进程。</p>
<p><strong>操作系统是中断驱动的</strong>，本身是一个死循环<code>while(1){ 操作系统代码 }</code>,所以系统是在循环中等待事件的发生，被动的调用资源去处理，而事件是由中断去通知系统的的。</p>
<h2 id="中断类型"><a href="#中断类型" class="headerlink" title="中断类型"></a>中断类型</h2><h3 id="外部中断"><a href="#外部中断" class="headerlink" title="外部中断"></a>外部中断</h3><p>外部中断又可以分为可屏蔽中断和不可屏蔽中断。</p>
<p><strong>可屏蔽中断</strong>：可以屏蔽的中断，像时钟、键盘、硬盘、网卡等发出的中断都是可以屏蔽的。</p>
<p><strong>不可屏蔽中断</strong>：既有不能屏蔽的意思，更准确地来说，一旦出现这种中断，操作系统将面临奔溃，无论你是否屏蔽似乎都没什么意义了，出现这种中断大多数是硬件问题，需要专业的硬件工程师做修理，像电源掉电、内存读写错误、奇偶校验错误都是不可屏蔽中断。</p>
<p>可屏蔽中断处理分为两部分，上半部和下半部。上半部是需要处理器紧急处理的，下半部是可以推迟一点处理的。例如，网卡接受到的网络数据将要装满缓冲区，它就会向处理器发出可屏蔽中断，通知处理器做上半部的处理，因为再不搬，数据就要丢失了，之后处理器就会将网卡里的网络数据搬到内存里，完成中断的上半部。下半部的话，就是对网络数据做一定的处理，这部分倒不是很紧急，放在下半部挺合适，处理器找个时间处理一下就好。</p>
<p>外部中断是通过两根信号线通知处理器的，一条是INTR（INTeRrupt）,另一条是NMI(Non Maskable,Interrupt)，分别用于传输可屏蔽中断信号和不可屏蔽中断信号。</p>
<p><img src="https://inews.gtimg.com/newsapp_ls/0/13190603245/0" alt="image-20210218143934728"> </p>
<p>不可屏蔽中断的中断向量号为 2。</p>
<h3 id="内部中断"><a href="#内部中断" class="headerlink" title="内部中断"></a>内部中断</h3><p>内部中断分为软中断和异常。</p>
<h4 id="软中断"><a href="#软中断" class="headerlink" title="软中断"></a>软中断</h4><p>软中断是用户主动发起的中断。</p>
<p>来自书本原话</p>
<blockquote>
<p>• “ int 8位立即数”。这是我们以后常用的指令，我们要通过它进行系统调用，8位立即数可表示256种中断，这与处理器所支持的中断数是相吻合的。<br>• “ int 3”。这可不是 int 空格3,它们之间无间隙。 int  3是调试断点指令，其所触发的中断向量号是3,以后在中断和异常表中大家会看到。我们用 gdb 或 bochs 调试程序时，实际上就是调试器  fork 了一个子进程，子进程用于运行被调试的程序。调试器中经常要设置断点，其原理就是父进程修改了子进程的指令,将其用 int  3指令替换，从而子进程调用了  int 3指令触发中断。用此指令实现调试的原理是 int 3指令的机器码是 Oxcc  ,断点本质上是指令的地址，调试器（父进程）将被调试进程（子进程）断点起始地址的第1个字节备份好之后在原地将该指令的第1字节修改为 Oxcc  。这样指令执行到断点处时，会去执行机器码为 Oxcc 的 int  3指令，该指令会触发3号中断，从而会去执行3号中断对应的中断处理程序，由于中断处理程序在运行时也要用到寄存器，为了保存所调试进程的现场，该中断处理程序必须先将当前的寄存器和相关内存单元压栈保存（提醒，当前寄存器和相关内存都属于那个被调试的进程)，用户在査看寄存器和变量时就是从栈中获取的。当恢复执行所调试的进程时，中断处理程序需要将之前备份的1字节还原至断点处，然后恢复各寄存器和内存单元的值,修改返回地址为断点地址，用 iret 指令退出中断，返回到用户进程继续执行。<br>•  into 。这是中断溢出指令，它所触发的中断向量号是4。不过，能否引发4号中断是要看 eflags 标志寄存器中的 OF 位是否为1,如果是1才会引发中断，否则该指令悄悄地什么都不做，低调得很。<br>•  bound 。这是检査数组索引越界指令，它可以触发5号中断，用于检査数组的索引下标是否在上下边界之内。该指令格式是 “bound  16/32位寄存器，16/32位内存”。目的操作数是用寄存器来存储的，其内容是待检测的数组下标值。源操作数是内存，其内容是数组下标的下边界和上边界。当执行 bound 指令时，若下标处于数组索引的范围之外，则会触发5号中断。<br>•  ud 2。未定义指令，这会触发第6号中断。该指令表示指令无效， CPU 无法识别。主动使用它发起中断，常用于软件测试中，无实际用途。</p>
</blockquote>
<p>总结一下如下</p>
<blockquote>
<ul>
<li>“int 8位立即数”，通过它进行系统调用</li>
<li>int3，int和3之间无空格，用于调试</li>
<li>into，中断溢出指令，当OF位也为1时，触发4号中断</li>
<li>bound，检查数组索引越界指令，越界时触发5号中断</li>
<li>ud2，未定义指令，触发6号中断</li>
</ul>
<p>补充：软中断int3断点调试指令，常用在GDB和Bochs调试器，具体的原理是</p>
<ol>
<li>父进程（调试器）fork了一个子进程，来运行被调试的程序，当用户在调试器（Bochs举例）上输入<code>b 0xXXXXXXXX</code>指令时，父进程会将该地址的指令的第一个字节<strong>备份</strong>，再用0xcc（int3的机器指令）替换</li>
<li>这样再输入<code>c</code>运行，子进程运行到断点处就会触发3号中断，进行<strong>中断处理程序</strong>，但在此之前，还需保存当前的寄存器和栈的状态，所以用户查看寄存器和栈都是在栈中的值。</li>
<li>当继续运行调试程序即输入<code>n</code>，父进程又会把<strong>原先备份替换回去</strong>，并把寄存器和栈恢复，修改返回地址为断点地址，用iret退出中断。</li>
</ol>
</blockquote>
<p>除第一种的“int 8 位立即数”之外，其他的几种又可以称为异常。</p>
<p>因为它们既具备软中断的“主动”行为，又具备异常的“错误”结果。</p>
<p>int指令是比较常用的软中断，像Linux系统int 80就是用来实现系统调用的，所以调用的很频繁。</p>
<h4 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h4><p>异常是执行指令时CPU内部遇到错误。</p>
<p>只要中断关系到“正常”运行，就不受 IF 位影响。</p>
<p>运行错误的意思是 例如 执行div命令 , 处理器发现分母为0。将会引发 0 号异常 ( 中断</p>
<p>异常根据严重分为三种:</p>
<blockquote>
<p>第一种是最轻的异常称为故障（Fault），这种异常是可以修复的，像缺页异常（Page fault）就是这种，处理器给软件以此改过自新的机会。LINUX虚拟内存就是基于page fault。</p>
<p>第二种是陷阱（Trap），这种异常一般是用户用于调试设下的。</p>
<p>第三种是最严重的，终止（Abort）。一旦无法修复，程序就没办法再运行下去，操作系统为了自保，只能将这个进程杀死。</p>
</blockquote>
<p>异常和中断的表格</p>
<p><img src="https://inews.gtimg.com/newsapp_ls/0/13190603261/0" alt="image-20210218145952797"> </p>
<h2 id="中断描述符"><a href="#中断描述符" class="headerlink" title="中断描述符"></a>中断描述符</h2><p>中断描述符表（Interrupt Descriptor Table，IDT）是保护模式下用于存储中断处理程序入口的表，当CPU 接收一个中断时，需要用中断向量在此表中检索对应的描述符，在该描述符中找到中断处理程序的起始地址，然后执行中断处理程序。</p>
<p>实模式下用于中断处理程序入口的表叫做中断向量表(IVT)，保护模式下则是中断描述符表(IDT)。</p>
<p>IVT在实模式下位于0~0x3ff共1024个字节，又知IVT可容纳256个中断向量，故每个中断向量用4字节描述；对比IVT，IDT表地址不受限制，在哪里都可以，每个描述符用8字节描述。这里主要讨论IDT，在IDT中描述符称之为门，也就是之前介绍过的门，这里再区别一下门和段描述符</p>
<ul>
<li>段描述符中描述的是一片内存区域</li>
<li>门描述符描述的是一段代码，除调用门外，任务门、中断门、陷阱门都可以存在于中断描述符中</li>
</ul>
<p>对比中断向量表，中断描述符表有两个区别。</p>
<p>（1）中断描述符表地址不限制，在哪里都可以。</p>
<p>（2）中断描述符表中的每个描述符用 8 字节描述。</p>
<p>IDT位置不固定，故CPU找到它需要通过一个寄存器<strong>IDTR</strong>，如下图，其中0<del>15位是表界限，也就是IDT大小减一，第16</del>47位是IDT的基地址，和之前的GDTR是一个原理</p>
<p><img src="https://inews.gtimg.com/newsapp_ls/0/13190603285/0" alt="image-20210219123836841"></p>
<p>6位的表界限范围是0<del>0xffff，即64KB，可容纳的描述符个数是64KB/8=8K=8192个。特别注意的是GDT中的第0个段描述符是不可用的，但IDT却无此限制，第0个门描述符也是可用的，处理器只支持256个中断，即0</del>254，中断描述符中其他的描述符不可用，还需要注意的是门描述符中的P位，构建IDT时需要将其置为0，表示门描述符的中断处理程序不在内存中。</p>
<p>加载IDTR需要用到lidt指令，用法是<code>lidt 48位内存数据</code></p>
<p>在这 48 位内存数据中，前 16 位是 IDT 表界限，后 32 位是 IDT 线性基地址。</p>
<p>中断的处理过程总结如下</p>
<ol>
<li>处理器根据中断向量号定位中断门描述符</li>
<li>处理器进行特权级检查</li>
<li>执行中断处理程序</li>
</ol>
<p><img src="https://inews.gtimg.com/newsapp_ls/0/13190603300/0" alt="image-20210219123939837"></p>
<p>中断发生之后需要执行中断处理程序，该中断处理程序是通过中断门描述符中保存的代码段选择子和段内偏移找到的，这个时候就需要重新加载段寄存器，也就是说需要在栈中保存一些寄存器信息(CS:EIP、eflags等)，保证中断之后执行的流程正确，当特权级变化的时候，压栈如下图所示</p>
<p><img src="https://inews.gtimg.com/newsapp_ls/0/13190603323/0" alt="image-20210219124014697"></p>
<p>图A、B：在发生中断是通过特权级的检测，发现需要向高特权级转移，所以要保存当前程序栈的SS和ESP的值，在这里记为ss_old, esp_old，然后在新栈中压入当前程序的eflags寄存器。</p>
<p>图C、D：由于要切换目标代码段，这种段间转移，要对CS和EIP进行备份，同样将其存入新栈中。某些异常会有错误码，用来标识异常发生在哪个段上，对于有错误码的情况，要将错误码也压入栈中。</p>
<p>当特权级没有变化的时候，就不需要压入旧栈的SS和EIP</p>
<p><img src="https://inews.gtimg.com/newsapp_ls/0/13190603361/0" alt="image-20210219124744872"> </p>
<p>返回的时候通过指令 <strong>iret</strong> 完成，<strong>iret</strong> 指令会从栈顶依次弹出EIP、CS、EFLAGS，根据特权级的变化还有ESP、SS。但是该指令并不验证数据的正确性，而且他从栈中弹出数据的顺序是不变的，也就是说，在有error_code的情况下，iret返回时并不会主动跳过这个数据，需要我们手动进行处理。、</p>
<h3 id="特权级检查"><a href="#特权级检查" class="headerlink" title="特权级检查"></a>特权级检查</h3><p>特权级别检查也和调用门的类似。</p>
<p>　　由于中断触发时，不用指定选择子，只有中断向量号，因此也不需要检查RPL。所以只需要用CPL与中断描述符的DPL和目标代码段的DPL相比较。</p>
<p>中断是通过中断向量号通知处理器的，所以<strong>不涉及RPL</strong>（如代码段描述符需要用段选择子来通知）。</p>
<ol>
<li><p>如果是软中断int n，int3，into等，这些是用户进程主动引起的，数值上要求<code>目标代码段DPL &lt;= CPL &lt;= 门描述符DPL</code>，为了避免特权级为3的用户进程主动调用某些只用于内核的例程（<strong>设置了门槛下限</strong>）</p>
</li>
<li><p>如果是外部中断、异常，这些是进程被动引发的，所以不需要考虑上面的情况，数值上要求<code>目标代码段DPL &lt;= CPL</code></p>
</li>
</ol>
<h3 id="if位"><a href="#if位" class="headerlink" title="if位"></a>if位</h3><p>eflags寄存器中<strong>开关中断</strong>的标志位，仅限于限制外部设备的中断。</p>
<p>调用中断门需要关闭，陷阱门和任务门不用</p>
<ol>
<li>由于中断门要避免中断嵌套，即处理过程中又调用中断，会触发一般保护性异常；</li>
<li>处理器允许陷阱门嵌套优先级更高的中断，任务门必须要嵌套才能实现多任务并发</li>
</ol>
<p>改变IF位的方式采用cli和sti专门的指令：由于通过pushf压栈的方式涉及到内存的访问，可以拆分成多步骤，<strong>不满足原子性要求</strong>。</p>
<h3 id="中断错误码"><a href="#中断错误码" class="headerlink" title="中断错误码"></a>中断错误码</h3><p>错误码最主要的部分就是选择子，只不过此选择子可以在多种表中检索描述符。</p>
<p><img src="https://inews.gtimg.com/newsapp_ls/0/13190603385/0" alt="image-20210219130241525"> </p>
<blockquote>
<p>EXT 表示 EXTernal event，即外部事件，用来指明中断源是否来自处理器外部，如果中断源是不可屏蔽中断 NMI 或外部设备，EXT 为 1，否则为 0。</p>
<p>IDT 表示选择子是否指向中断描述符表 IDT，IDT 位为 1，则表示此选择子指向中断描述符表，否则指向全局描述符表 GDT 或局部描述符表 LDT。</p>
<p>TI 和选择子中 TI 是一个意思，为 0 时用来指明选择子是从 GDT 中检索描述符，为 1 时是从 LDT 中检索描述符。当然，只有在 IDT 位为 0 时 TI 位才有意义。</p>
<p>选择子高 13 位索引就是选择子中用来在表中索引描述符用的下标。高 16 位是保留位，全 0。 </p>
</blockquote>
<p>有时候不仅错误码的高 16 位全为 0，低 16 位也全为 0，那一个全 0 的错误码能指明什么信息？当全 0 的错误码出现时，表示中断的发生与特定的段无关，或者引用了一个空描述符，引用描述符就是往段寄存器中加载选择子的时候，处理器发现选择子指向的描述符是空的。</p>
<p>中断返回时，iret 指令并不会把错误码从栈中弹出，所以在中断处理程序中需要手动用栈指针跨过错误码或将其弹出。否则栈顶处若不是 EIP（EIP_old）的话，iret 返回时将会载入错误的值到后续寄存器。</p>
<p>通常能够压入错误码的中断属于中断向量号在 0～32 之内的异常，而外部中断（中断向量号在 32～255 之间）和 int 软中断并不会产生错误码。通常我们并不用处理错误码。</p>
<h2 id="8259A芯片"><a href="#8259A芯片" class="headerlink" title="8259A芯片"></a>8259A芯片</h2><p>可屏蔽中断的代理8259A芯片，当多个中断到来时，代理可以用队列（IRR）存储中断，判别哪个中断会被处理器处理，并与处理器通信。</p>
<p>中断设备会连接到代理相应的IRQ接口，多个8259A芯片级联在一起可以支持更多的中断信号，一个8259芯片支持8种中断，两个芯片支持15种中断（其中1个IRQ用来连接从片）。</p>
<p><img src="https://inews.gtimg.com/newsapp_ls/0/13190603399/0" alt="image-20210219142913136"> </p>
<p>芯片内部结构如下图：</p>
<p><img src="https://inews.gtimg.com/newsapp_ls/0/13190603411/0" alt="image-20210219142942847"> </p>
<p>各个模块的作用:</p>
<blockquote>
<p>• INT : 8259 A 选出优先级最髙的中断请求后，发信号通知 CPU 。</p>
<p>• INTA : INT Acknowledge ,中断响应信号。位于8259 A 中的 INTA 接收来自 CPU 的 INTA 接口的中断响应信号。</p>
<p>• IMR: InterruptMaskRegister, 中断屏蔽寄存器，宽度是 8 位，用来屏蔽某个外设的中断。</p>
<p>• IRR : Interrupt Request Register ，中断请求寄存器，宽度是8位。它的作用是接受经过 IMR 寄存器过滤后的中断信号并锁存，此寄存器中全是等待处理的中断，“相当于“5259 A 维护的未处理中断信号队列。</p>
<p>• PR : Priority Resolver ,优先级仲裁器。当有多个中断同时发生，或当有新的中断请求进来时，将它与当前正在处理的中断进行比较，找出优先级更高的中断。</p>
<p>• ISR: In-Service Register, 中断服务寄存器，宽度是 8 位。当某个中断正在被处理时，保存在此寄存器中。</p>
</blockquote>
<p><strong>工作原理</strong></p>
<p>　　当中断到来时，首先会经过中断屏蔽寄存器（IMR)，查看该中断是否被屏蔽了，如果屏蔽的话IMR对应的位是为1的（比如主片IMR最低位为1的话，时钟中断就被屏蔽了，看上面那个级联的图）。如果没有被屏蔽，进入到IRR中断请求寄存器里，将该中断对应的位置为1，这个操作相当于将中断放进了队列里，因为有可能会有多个中断等待处理，所以需要一个队列来做缓存。</p>
<p>　　再讲讲处理中断的流程：</p>
<p>​       ①PR优先权判别器会从IRR里挑选出优先级最高的中断（IRQx，x越低优先级最高，所以时钟优先级最高），准备让处理器处理，代理通过INTR向处理器发送INT信号，告诉处理器有中断要处理。</p>
<p>　　②处理器处理好现在执行的指令后，通过INTA发送信号告诉代理，我已经准备好处理中断信号了。</p>
<p>　　③代理接受该信号后，将刚才选出来最高优先级的中断在ISR对应位置为1，IRR对应位置为0。</p>
<p>　　④处理器再次发送INTR信号给代理，告诉代理我需要这个中断的中断向量号。</p>
<p>　　⑤代理通过数据总线向处理器发送PR判别的中断向量号。</p>
<p>　　⑥如果8259A芯片的EOI(End Of Interrupt信号)被置为非自动模式（手工模式）， 处理器处理中断后，向代理发送一个EOI(End Of Interrupt信号)，代理接受后知道中断已经处理完了，将ISR对应位置为0;</p>
<p>　　⑦如果8259A芯片的EOI(End Of Interrupt信号)被置为自动模式，在接受到第二个INTR信号就会将ISR对应位置为0。</p>
<p>　　以上就是接收中断和处理中断的流程。</p>
<p>　　还有一种情况是，如果在代理发送中断向量号之前，来了一个优先级别更高的中断，就会将ISR之前准备处理中断对应位置为0，IRR对应位置为1，将新来的中断的向量号发给处理器。</p>
<p>中断处理框架：</p>
<p>（1） 构造好IDT</p>
<p>（2） 提供中断向量号</p>
<p>8259A内的两组寄存器： ICW （初始化命令字）+ OCW （操作命令字）</p>
<blockquote>
<p>ICW1 ： 0 0 0 1 LTIM（中断检测方式） ADI（8085的时间间隔） SNGL（单片或级联） IC4（是否需要ICW4）</p>
<p>ICW2： T7 T6 T5 T4 T3 ID2 ID1 ID0 （只需要填写T3～T7）</p>
<p>ICW3： （仅在ICW的SNGL = 1 的情况下）</p>
<p>　　　　主片： S7 S6 S5 S4 S3 S2 S1 S0</p>
<p>　　　　从片： 0 0 0 0 0 ID2 ID1 ID0 （第三位来指定和主片相连的接口）</p>
<p>ICW4： 0 0 0 SFNM BUF M/S AEOI μPM</p>
<p>OCW1：M7～M0 （对应 IRQ0 ~ IRQ7) IMR屏蔽中断</p>
<p>OCW2：写入到主片的0x20和从片的）0xA0端口</p>
</blockquote>
<h2 id="编写中断处理程序"><a href="#编写中断处理程序" class="headerlink" title="编写中断处理程序"></a>编写中断处理程序</h2><p>通过操作8259A芯片实现第一个中断处理程序，本质上是一个可编程中断控制器，处理流程如下，<code>init_all</code>负责初始化所有设备及结构体，然后调用<code>idt_init</code>初始化中断相关内容，内部分别调用了<code>pic_init</code>和<code>idt_desc_init</code>实现，其中<code>pic_init</code>初始化8259A，<code>idt_desc_init</code>负责对中断描述符IDT表进行初始化，最后再对IDT表进行加载</p>
<p>我们需要进行以下几个步骤</p>
<ol>
<li>用汇编语言实现中断处理程序</li>
<li>创建中断描述符表IDT，安装中断处理程序</li>
<li>用内联汇编实现端口I/O函数(对端口的读写操作)</li>
<li>设置8259A</li>
</ol>
<h3 id="with-asm"><a href="#with-asm" class="headerlink" title="with_asm"></a>with_asm</h3><p><code>kernel.S</code>  中断处理程序的编写</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">[bits 32]</span><br><span class="line"></span><br><span class="line">; 对于CPU会自动压入错误码的中断类型，无需额外的操作</span><br><span class="line">%define ERROR_CODE nop</span><br><span class="line">; 如果CPU没有压入错误码，为了保持处理逻辑的一致性，我们需要手动压入一个0</span><br><span class="line">%define ZERO push 0</span><br><span class="line"></span><br><span class="line">extern put_str</span><br><span class="line"></span><br><span class="line">section .data</span><br><span class="line">intr_str db &quot;interrupt occur!&quot;, 0xa, 0</span><br><span class="line">global intr_entry_table</span><br><span class="line">intr_entry_table:</span><br><span class="line"></span><br><span class="line">; 中断处理程序宏定义</span><br><span class="line">%macro VECTOR 2</span><br><span class="line">section .text</span><br><span class="line">intr%1entry:                 ;每个中断处理程序都要压入中断向量号</span><br><span class="line">                             ;所以一个中断类型一个中断处理程序</span><br><span class="line">                             ;自己知道自己的中断向量号是多少</span><br><span class="line">    %2</span><br><span class="line">    push intr_str</span><br><span class="line">    call put_str</span><br><span class="line">    add esp, 4 		;跳过参数</span><br><span class="line">			  	   ;如果是从片上进入的中断，除了往从片上发送 EOI 外，还要往主片上发送 EOI</span><br><span class="line"></span><br><span class="line">    mov al, 0x20	;中断结束命令 EOI</span><br><span class="line">    out 0xa0, al	;向从片发送</span><br><span class="line">    out 0x20, al	;向主片发送</span><br><span class="line"></span><br><span class="line">    add esp, 4   	;跨过 error_code </span><br><span class="line">    iret            ;从中断返回，32 位下等同指令 iretd</span><br><span class="line"></span><br><span class="line">section .data</span><br><span class="line">    dd intr%1entry        ;存储各个中断入口程序的地址</span><br><span class="line"> 						;形成 intr_entry_table 数组</span><br><span class="line"></span><br><span class="line">%endmacro</span><br><span class="line"></span><br><span class="line">VECTOR 0x00, ZERO</span><br><span class="line">VECTOR 0x01, ZERO</span><br><span class="line">VECTOR 0x02, ZERO</span><br><span class="line">VECTOR 0x03, ZERO</span><br><span class="line">VECTOR 0x04, ZERO</span><br><span class="line">VECTOR 0x05, ZERO</span><br><span class="line">VECTOR 0x06, ZERO</span><br><span class="line">VECTOR 0x07, ZERO</span><br><span class="line">VECTOR 0x08, ZERO</span><br><span class="line">VECTOR 0x09, ZERO</span><br><span class="line">VECTOR 0x0a, ZERO</span><br><span class="line">VECTOR 0x0b, ZERO</span><br><span class="line">VECTOR 0x0c, ZERO</span><br><span class="line">VECTOR 0x0d, ZERO</span><br><span class="line">VECTOR 0x0e, ZERO</span><br><span class="line">VECTOR 0x0f, ZERO</span><br><span class="line">VECTOR 0x10, ZERO</span><br><span class="line">VECTOR 0x11, ZERO</span><br><span class="line">VECTOR 0x12, ZERO</span><br><span class="line">VECTOR 0x13, ZERO</span><br><span class="line">VECTOR 0x14, ZERO</span><br><span class="line">VECTOR 0x15, ZERO</span><br><span class="line">VECTOR 0x16, ZERO</span><br><span class="line">VECTOR 0x17, ZERO</span><br><span class="line">VECTOR 0x18, ZERO</span><br><span class="line">VECTOR 0x19, ZERO</span><br><span class="line">VECTOR 0x1a, ZERO</span><br><span class="line">VECTOR 0x1b, ZERO</span><br><span class="line">VECTOR 0x1c, ZERO</span><br><span class="line">VECTOR 0x1d, ZERO</span><br><span class="line">VECTOR 0x1e, ERROR_CODE</span><br><span class="line">VECTOR 0x1f, ZERO</span><br><span class="line">VECTOR 0x20, ZERO</span><br></pre></td></tr></table></figure>

<p><code>interrupt.c</code> </p>
<p>将中断处理程序地址装载到中断描述符中。</p>
<p>加载 IDT，开启中断，把中断描述符表 IDT 的信息加载到 IDTR 寄存器。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">"stdint.h"</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">"global.h"</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">"io.h"</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">"interrupt.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> IDT_DESC_CNT 0x21 <span class="comment">//支持的中断数</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> PIC_M_CTRL 0x20</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> PIC_M_DATA 0x21</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> PIC_S_CTRL 0xa0</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> PIC_S_DATA 0xa1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*中断门描述符结构体*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gate_desc</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint16_t</span> func_offset_low_word;</span><br><span class="line">    <span class="keyword">uint16_t</span> selector;</span><br><span class="line">    <span class="keyword">uint8_t</span> dcount; <span class="comment">//此项为双字计数字段，是门描述符中的第 4 字节</span></span><br><span class="line">                    <span class="comment">//此项固定值，不用考虑</span></span><br><span class="line">    <span class="keyword">uint8_t</span> attribute;</span><br><span class="line">    <span class="keyword">uint16_t</span> func_offset_high_word;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">make_idt_desc</span><span class="params">(struct gate_desc* p_gdesc, <span class="keyword">uint8_t</span> attr, intr_handler function)</span></span>;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">gate_desc</span> <span class="title">idt</span>[<span class="title">IDT_DESC_CNT</span>];</span>  <span class="comment">// idt 是中断描述符表</span></span><br><span class="line">                                            <span class="comment">//本质上就是个中断门描述符数组</span></span><br><span class="line"><span class="keyword">extern</span> intr_handler intr_entry_table[IDT_DESC_CNT]; <span class="comment">// 声明引用定义在 kernel.S  </span></span><br><span class="line">                                                    <span class="comment">// 中的中断处理函数入口数组</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建中断门描述符.</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">make_idt_desc</span><span class="params">(struct gate_desc* p_gdesc, <span class="keyword">uint8_t</span> attr, intr_handler function)</span> </span>&#123;</span><br><span class="line">    p_gdesc-&gt;func_offset_low_word = (<span class="keyword">uint32_t</span>) function &amp; <span class="number">0x0000FFFF</span>;</span><br><span class="line">    p_gdesc-&gt;selector = SELECTOR_K_CODE;</span><br><span class="line">    p_gdesc-&gt;dcount = <span class="number">0</span>;</span><br><span class="line">    p_gdesc-&gt;attribute = attr;</span><br><span class="line">    p_gdesc-&gt;func_offset_high_word = ((<span class="keyword">uint32_t</span>) function &amp; <span class="number">0xFFFF0000</span>) &gt;&gt; <span class="number">16</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化中断描述符表.</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">idt_desc_init</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; IDT_DESC_CNT; i++) &#123;</span><br><span class="line">        make_idt_desc(&amp;idt[i], IDT_DESC_ATTR_DPL0, intr_entry_table[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    put_str(<span class="string">"idt_desc_init done.\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">pic_init</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 初始化主片</span></span><br><span class="line">    outb(PIC_M_CTRL, <span class="number">0x11</span>); <span class="comment">// ICW1: 边沿触发,级联 8259, 需要 ICW4</span></span><br><span class="line">    outb(PIC_M_DATA, <span class="number">0x20</span>); <span class="comment">// ICW2: 起始中断向量号为 0x20</span></span><br><span class="line">                            <span class="comment">// 也就是 IR[0-7] 为 0x20 ～ 0x27</span></span><br><span class="line">    outb(PIC_M_DATA, <span class="number">0x04</span>); <span class="comment">// ICW3: IR2 接从片</span></span><br><span class="line">    outb(PIC_M_DATA, <span class="number">0x01</span>); <span class="comment">// ICW4: 8086 模式, 正常 EOI</span></span><br><span class="line"></span><br><span class="line">    outb(PIC_S_CTRL, <span class="number">0x11</span>); <span class="comment">// ICW1: 边沿触发,级联 8259, 需要 ICW4</span></span><br><span class="line">    outb(PIC_S_DATA, <span class="number">0x28</span>); <span class="comment">// ICW2: 起始中断向量号为 0x28</span></span><br><span class="line">                            <span class="comment">// 也就是 IR[8-15]为 0x28 ～ 0x2F</span></span><br><span class="line">    outb(PIC_S_DATA, <span class="number">0x02</span>); <span class="comment">// ICW3: 设置从片连接到主片的 IR2 引脚</span></span><br><span class="line">    outb(PIC_S_DATA, <span class="number">0x01</span>); <span class="comment">// ICW4: 8086 模式, 正常 EOI</span></span><br><span class="line">    <span class="comment">/*打开主片上 IR0,也就是目前只接受时钟产生的中断 */</span></span><br><span class="line">    outb(PIC_M_DATA, <span class="number">0xfe</span>);</span><br><span class="line">    outb(PIC_S_DATA, <span class="number">0xff</span>);</span><br><span class="line"></span><br><span class="line">    put_str(<span class="string">"pic_init done.\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*完成有关中断的所有初始化工作*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">idt_init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    put_str(<span class="string">"idt_init start.\n"</span>);</span><br><span class="line">    idt_desc_init();  <span class="comment">// 初始化中断描述符表</span></span><br><span class="line">    pic_init();       <span class="comment">// 初始化 8259A</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载idt</span></span><br><span class="line">    <span class="keyword">uint64_t</span> idt_operand = ((<span class="keyword">sizeof</span>(idt) - <span class="number">1</span>) | ((<span class="keyword">uint64_t</span>) ((<span class="keyword">uint32_t</span>) idt &lt;&lt; <span class="number">16</span>)));</span><br><span class="line">    <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span> <span class="params">(<span class="string">"lidt %0"</span> : : <span class="string">"m"</span> (idt_operand))</span></span>;</span><br><span class="line">    put_str(<span class="string">"idt_init done.\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>interrupt.h</code> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef void* intr_handler;</span><br></pre></td></tr></table></figure>

<p><code>global.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _KERNEL_GLOBAL_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _KERNEL_GLOBAL_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">"stdint.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> RPL0 0</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> RPL1 1</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> RPL2 2</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> RPL3 3</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> TI_GDT 0</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> TI_LDT 1</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> SELECTOR_K_CODE ((1 &lt;&lt; 3) + (TI_GDT &lt;&lt; 2) + RPL0)</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> SELECTOR_K_DATA ((2 &lt;&lt; 3) + (TI_GDT &lt;&lt; 2) + RPL0)</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> SELECTOR_K_STACK SELECTOR_K_DATA</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> SELECTOR_K_GS ((3 &lt;&lt; 3) + (TI_GDT &lt;&lt; 2) + RPL0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* IDT描述符属性 */</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> IDT_DESC_P 1</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> IDT_DESC_DPL0 0</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> IDT_DESC_DPL3 3</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> IDT_DESC_32_TYPE 0xE   <span class="comment">// 32 位的门</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> IDT_DESC_16_TYPE 0x6   <span class="comment">// 16 位的门</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> IDT_DESC_ATTR_DPL0 \</span></span><br><span class="line">    ((IDT_DESC_P &lt;&lt; <span class="number">7</span>) + (IDT_DESC_DPL0 &lt;&lt; <span class="number">5</span>) + IDT_DESC_32_TYPE)</span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> IDT_DESC_ATTR_DPL3 \</span></span><br><span class="line">    ((IDT_DESC_P &lt;&lt; <span class="number">7</span>) + (IDT_DESC_DPL3 &lt;&lt; <span class="number">5</span>) + IDT_DESC_32_TYPE)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>内联汇编实现端口 I/O 函数</p>
<p><code>io.h</code></p>
<p>io.h 中就定义了 4 个函数，分别是。</p>
<blockquote>
<p>（1）一次写入 1 个字节的 outb 函数。</p>
<p>（2）一次写入多个字的 outsw 函数，注意，是以 2 字节为单位的。</p>
<p>（3）一次读入 1 个字节的 inb 函数。</p>
<p>（4）一次读入多个字的 insw 函数，同样以 2 字节为单位。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/******************机器模式 ******************* </span></span><br><span class="line"><span class="comment">b -- 输出寄存器 QImode 名称，即寄存器中的最低 8 位:[a-d]l</span></span><br><span class="line"><span class="comment">w -- 输出寄存器 HImode 名称，即寄存器中 2 个字节的部分,如[a-d]x </span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">HImode </span></span><br><span class="line"><span class="comment">"Half-Integer"模式，表示一个两字节的整数</span></span><br><span class="line"><span class="comment">QImode </span></span><br><span class="line"><span class="comment">"Quarter-Integer"模式，表示一个一字节的整数</span></span><br><span class="line"><span class="comment">******************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _LIB_IO_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _LIB_IO_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdint.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  向指定的端口写入一个字节的数据.</span></span><br><span class="line"><span class="comment"> 	对端口指定 N 表示 0～255, d 表示用 dx 存储端口号, </span></span><br><span class="line"><span class="comment">    %b0 表示对应 al , %w1 表示对应 dx */</span></span><br><span class="line"> */ </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">outb</span><span class="params">(<span class="keyword">uint16_t</span> port, <span class="keyword">uint8_t</span> data)</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span> <span class="params">(<span class="string">"outb %b0, %w1"</span> : : <span class="string">"a"</span> (data), <span class="string">"Nd"</span> (port))</span></span>;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  将addr起始处的word_cnt个字节写入端口port.</span></span><br><span class="line"><span class="comment">   	'+' 表示此限制即做输入,又做输出. </span></span><br><span class="line"><span class="comment">  	outsw 是把 ds:esi 处的 16 位的内容写入 port 端口，我们在设置段描述符时, </span></span><br><span class="line"><span class="comment">  	已经将 ds,es,ss 段的选择子都设置为相同的值了，此时不用担心数据错乱｡</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">outsw</span><span class="params">(<span class="keyword">uint16_t</span> port, <span class="keyword">const</span> <span class="keyword">void</span>* addr, <span class="keyword">uint32_t</span> word_cnt)</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span> <span class="params">(<span class="string">"cld; rep outsw"</span> : <span class="string">"+S"</span> (addr), <span class="string">"+c"</span> (word_cnt) : <span class="string">"d"</span> (port))</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  将从端口port读入的一个字节返回.</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">uint8_t</span> <span class="title">inb</span><span class="params">(<span class="keyword">uint16_t</span> port)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint8_t</span> data;</span><br><span class="line">    <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span> <span class="params">(<span class="string">"inb %w1, %b0"</span> : <span class="string">"=a"</span> (data) : <span class="string">"Nd"</span> (port))</span></span>;</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  将从port读取的word_cnt字节写入addr.</span></span><br><span class="line"><span class="comment"> 	insw 是将从端口 port 处读入的 16 位内容写入 es:edi 指向的内存, </span></span><br><span class="line"><span class="comment">   	我们在设置段描述符时，已经将 ds,es,ss 段的选择子都设置为相同的值了, </span></span><br><span class="line"><span class="comment"> 	此时不用担心数据错乱｡ </span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">insw</span><span class="params">(<span class="keyword">uint16_t</span> port, <span class="keyword">void</span>* addr, <span class="keyword">uint32_t</span> word_cnt)</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span> <span class="params">(<span class="string">"cld; rep insw"</span> : <span class="string">"+D"</span> (addr), <span class="string">"+c"</span> (word_cnt) : <span class="string">"d"</span> (port) : <span class="string">"memory"</span>)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p><code>init.c</code> 触发的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"init.h"</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"print.h"</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"interrupt.h"</span> </span></span><br><span class="line"> </span><br><span class="line"><span class="comment">/*负责初始化所有模块 */</span> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_all</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    put_str(<span class="string">"init_all\n"</span>); </span><br><span class="line">    idt_init(); <span class="comment">//初始化中断</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>init.h</code> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void init_all(void);</span><br></pre></td></tr></table></figure>

<p><code>main.c</code> 测试代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">"kernel/print.h"</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">"init.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    put_str(<span class="string">"I am kernel.\n"</span>);</span><br><span class="line">    init_all();</span><br><span class="line">    put_str(<span class="string">"Init finished.\n"</span>);</span><br><span class="line">    <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span> <span class="params">(<span class="string">"sti"</span>)</span></span>;</span><br><span class="line">    put_str(<span class="string">"Turn on the interrupt.\n"</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>新添加中断后的文件树如下所示，<code>build</code>中是生成后的文件，<code>device</code>中存放的是为了提高中断频率对8253计数器的操作，<code>kernel</code>中新加的<code>interrupt</code>是对中断初始化的主要文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── boot</span><br><span class="line">│   ├── include</span><br><span class="line">│   │   └── boot.inc</span><br><span class="line">│   ├── loader.bin</span><br><span class="line">│   ├── loader.S</span><br><span class="line">│   ├── mbr.bin</span><br><span class="line">│   └── mbr.S</span><br><span class="line">├── build</span><br><span class="line">│   ├── init.o</span><br><span class="line">│   ├── interrupt.o</span><br><span class="line">│   ├── kernel.bin</span><br><span class="line">│   ├── kernel.o</span><br><span class="line">│   ├── main.o</span><br><span class="line">│   ├── print.o</span><br><span class="line">├── kernel</span><br><span class="line">│   ├── global.h</span><br><span class="line">│   ├── init.c</span><br><span class="line">│   ├── init.h</span><br><span class="line">│   ├── interrupt.c</span><br><span class="line">│   ├── interrupt.h</span><br><span class="line">│   ├── kernel.S</span><br><span class="line">│   └── main.c</span><br><span class="line">└── lib</span><br><span class="line">    ├── kernel</span><br><span class="line">    │   ├── io.h</span><br><span class="line">    │   ├── print.h</span><br><span class="line">    │   ├── print.o</span><br><span class="line">    │   └── print.S</span><br><span class="line">    ├── stdint.h</span><br><span class="line">    └── user</span><br></pre></td></tr></table></figure>

<p>编译如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;编译c程序，生成目标文件，这里需要关闭栈保护并指定32位程序</span><br><span class="line">sudo gcc -m32 -fno-stack-protector -I lib&#x2F;kernel -I lib&#x2F; -I kernel -c -fno-builtin -o build&#x2F;init.o kernel&#x2F;init.c </span><br><span class="line">sudo gcc -m32 -fno-stack-protector -I lib&#x2F;kernel -I lib&#x2F; -I kernel -c -fno-builtin -o build&#x2F;main.o kernel&#x2F;main.c</span><br><span class="line">sudo gcc -m32 -fno-stack-protector -I lib&#x2F;kernel -I lib&#x2F; -I kernel -c -fno-builtin -o build&#x2F;interrupt.o kernel&#x2F;interrupt.c</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;编译汇编</span><br><span class="line">sudo nasm -f elf -o build&#x2F;print.o lib&#x2F;kernel&#x2F;print.S</span><br><span class="line">sudo nasm -f elf -o build&#x2F;kernel.o kernel&#x2F;kernel.S</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;链接</span><br><span class="line">sudo ld -m elf_i386 -Ttext 0xc0001500 -e main -o build&#x2F;kernel.bin build&#x2F;main.o build&#x2F;init.o build&#x2F;interrupt.o build&#x2F;print.o build&#x2F;kernel.o</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;写入img</span><br><span class="line">&#x2F;&#x2F;sudo dd if&#x3D;build&#x2F;kernel.bin of&#x3D;&#x2F;home&#x2F;fyz&#x2F;sc&#x2F;bochs-2.6.2&#x2F;hd60M.img bs&#x3D;512 count&#x3D;200 seek&#x3D;9 conv&#x3D;notrunc</span><br><span class="line">sudo dd if&#x3D;.&#x2F;kernel.bin of&#x3D;&#x2F;home&#x2F;fyz&#x2F;sc&#x2F;bochs-2.6.2&#x2F;hd60M.img bs&#x3D;512 count&#x3D;200 seek&#x3D;9 conv&#x3D;notrunc</span><br><span class="line"></span><br><span class="line">sudo bin&#x2F;bochs -f bochsrc.disk</span><br></pre></td></tr></table></figure>

<p>运行结果 （ 凭单身手速截图 不容易</p>
<p><img src="https://inews.gtimg.com/newsapp_ls/0/13190603437/0" alt="image-20210221023901056"> </p>
<h3 id="improve"><a href="#improve" class="headerlink" title="improve"></a>improve</h3><p>除了外部声明了一个中断处理程序数组外，修改部分都在宏定义内，过程主要是</p>
<ol>
<li>压入错误码（具体看注释）</li>
<li>调用c程前将段寄存器和8个通用寄存器压栈</li>
<li>设置结束方式和中断优先级</li>
<li>压入中断号</li>
<li>调用c程：表中每个地址都为32位(4字节)，所以<code>[idt_table+中断号*4]</code>即可访问</li>
<li>跳过错误码，弹栈，跳过中断号</li>
<li>中断返回</li>
</ol>
<p><img src="https://inews.gtimg.com/newsapp_ls/0/13190603473/0" alt="image-20210221025911419"> </p>
<p><img src="https://inews.gtimg.com/newsapp_ls/0/13190603490/0" alt="image-20210221030030159"> </p>
<p><code>interrupt.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">"stdint.h"</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">"global.h"</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">"io.h"</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">"interrupt.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> IDT_DESC_CNT 0x21  <span class="comment">//支持的中断数</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> PIC_M_CTRL 0x20</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> PIC_M_DATA 0x21</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> PIC_S_CTRL 0xa0</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> PIC_S_DATA 0xa1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*中断门描述符结构体*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gate_desc</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint16_t</span> func_offset_low_word;</span><br><span class="line">    <span class="keyword">uint16_t</span> selector;</span><br><span class="line">    <span class="keyword">uint8_t</span> dcount; <span class="comment">//此项为双字计数字段，是门描述符中的第 4 字节</span></span><br><span class="line">                    <span class="comment">//此项固定值，不用考虑</span></span><br><span class="line">    <span class="keyword">uint8_t</span> attribute;</span><br><span class="line">    <span class="keyword">uint16_t</span> func_offset_high_word;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 中断的名称.</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="keyword">char</span>* intr_name[IDT_DESC_CNT];   <span class="comment">//用于保存异常的名字</span></span><br><span class="line">intr_handler idt_table[IDT_DESC_CNT];</span><br><span class="line"><span class="comment">//定义中断处理程序数组，在 kernel.S 中定义的 intrXXentry </span></span><br><span class="line"><span class="comment">//只是中断处理程序的入口，最终调用的是 ide_table 中的处理程序</span></span><br><span class="line"><span class="keyword">extern</span> intr_handler intr_entry_table[IDT_DESC_CNT];</span><br><span class="line"><span class="comment">//声明引用定义在 kernel.S 中的中断处理函数入口数组</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init_custom_handler_name</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">make_idt_desc</span><span class="params">(struct gate_desc* p_gdesc, <span class="keyword">uint8_t</span> attr, intr_handler function)</span></span>;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">gate_desc</span> <span class="title">idt</span>[<span class="title">IDT_DESC_CNT</span>];</span>  <span class="comment">// idt 是中断描述符表</span></span><br><span class="line">                                            <span class="comment">//本质上就是个中断门描述符数组</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通用的中断处理函数.</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">general_intr_handler</span><span class="params">(<span class="keyword">uint8_t</span> vec_nr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (vec_nr == <span class="number">0x27</span> || vec_nr == <span class="number">0x2f</span>) &#123;</span><br><span class="line">        <span class="comment">// 伪中断，无需处理</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    put_str(<span class="string">"int vector: 0x"</span>);</span><br><span class="line">    put_int(vec_nr);</span><br><span class="line">    put_char(<span class="string">'\n'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通用(默认)的异常/中断处理器注册.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">exception_handler_init</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; IDT_DESC_CNT; i++) &#123;</span><br><span class="line">        idt_table[i] = general_intr_handler; </span><br><span class="line">        <span class="comment">//idt_table 数组中的函数是在进入中断后根据中断向量号调用的</span></span><br><span class="line">        intr_name[i] = <span class="string">"unknown"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    init_custom_handler_name();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置需要自定义的中断名称.</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init_custom_handler_name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    intr_name[<span class="number">0</span>] = <span class="string">"#DE Divide Error"</span>;</span><br><span class="line">    intr_name[<span class="number">1</span>] = <span class="string">"#DB Debug Exception"</span>;</span><br><span class="line">    intr_name[<span class="number">2</span>] = <span class="string">"NMI Interrupt"</span>;</span><br><span class="line">    intr_name[<span class="number">3</span>] = <span class="string">"#BP Breakpoint Exception"</span>;</span><br><span class="line">    intr_name[<span class="number">4</span>] = <span class="string">"#OF Overflow Exception"</span>;</span><br><span class="line">    intr_name[<span class="number">5</span>] = <span class="string">"#BR BOUND Range Exceeded Exception"</span>;</span><br><span class="line">    intr_name[<span class="number">6</span>] = <span class="string">"#UD Invalid Opcode Exception"</span>;</span><br><span class="line">    intr_name[<span class="number">7</span>] = <span class="string">"#NM Device Not Available Exception"</span>;</span><br><span class="line">    intr_name[<span class="number">8</span>] = <span class="string">"#DF Double Fault Exception"</span>;</span><br><span class="line">    intr_name[<span class="number">9</span>] = <span class="string">"Coprocessor Segment Overrun"</span>;</span><br><span class="line">    intr_name[<span class="number">10</span>] = <span class="string">"#TS Invalid TSS Exception"</span>;</span><br><span class="line">    intr_name[<span class="number">11</span>] = <span class="string">"#NP Segment Not Present"</span>;</span><br><span class="line">    intr_name[<span class="number">12</span>] = <span class="string">"#SS Stack Fault Exception"</span>;</span><br><span class="line">    intr_name[<span class="number">13</span>] = <span class="string">"#GP General Protection Exception"</span>;</span><br><span class="line">    intr_name[<span class="number">14</span>] = <span class="string">"#PF Page-Fault Exception"</span>;</span><br><span class="line">    intr_name[<span class="number">16</span>] = <span class="string">"#MF 0x87 FPU Floating-Point Error"</span>;</span><br><span class="line">    intr_name[<span class="number">17</span>] = <span class="string">"#AC Alignment Check Exception"</span>;</span><br><span class="line">    intr_name[<span class="number">18</span>] = <span class="string">"#MC Machine-Check Exception"</span>;</span><br><span class="line">    intr_name[<span class="number">19</span>] = <span class="string">"#XF SIMD Floating-Point Exception"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建中断门描述符.</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">make_idt_desc</span><span class="params">(struct gate_desc* p_gdesc, <span class="keyword">uint8_t</span> attr, intr_handler function)</span> </span>&#123;</span><br><span class="line">    p_gdesc-&gt;func_offset_low_word = (<span class="keyword">uint32_t</span>) function &amp; <span class="number">0x0000FFFF</span>;</span><br><span class="line">    p_gdesc-&gt;selector = SELECTOR_K_CODE;</span><br><span class="line">    p_gdesc-&gt;dcount = <span class="number">0</span>;</span><br><span class="line">    p_gdesc-&gt;attribute = attr;</span><br><span class="line">    p_gdesc-&gt;func_offset_high_word = ((<span class="keyword">uint32_t</span>) function &amp; <span class="number">0xFFFF0000</span>) &gt;&gt; <span class="number">16</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化中断描述符表.</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">idt_desc_init</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; IDT_DESC_CNT; i++) &#123;</span><br><span class="line">        make_idt_desc(&amp;idt[i], IDT_DESC_ATTR_DPL0, intr_entry_table[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    put_str(<span class="string">"idt_desc_init done.\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">pic_init</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 初始化主片</span></span><br><span class="line">    outb(PIC_M_CTRL, <span class="number">0x11</span>); <span class="comment">// ICW1: 边沿触发,级联 8259, 需要 ICW4</span></span><br><span class="line">    outb(PIC_M_DATA, <span class="number">0x20</span>); <span class="comment">// ICW2: 起始中断向量号为 0x20</span></span><br><span class="line">                            <span class="comment">// 也就是 IR[0-7] 为 0x20 ～ 0x27</span></span><br><span class="line">    outb(PIC_M_DATA, <span class="number">0x04</span>); <span class="comment">// ICW3: IR2 接从片</span></span><br><span class="line">    outb(PIC_M_DATA, <span class="number">0x01</span>); <span class="comment">// ICW4: 8086 模式, 正常 EOI</span></span><br><span class="line"></span><br><span class="line">    outb(PIC_S_CTRL, <span class="number">0x11</span>); <span class="comment">// ICW1: 边沿触发,级联 8259, 需要 ICW4</span></span><br><span class="line">    outb(PIC_S_DATA, <span class="number">0x28</span>); <span class="comment">// ICW2: 起始中断向量号为 0x28</span></span><br><span class="line">                            <span class="comment">// 也就是 IR[8-15]为 0x28 ～ 0x2F</span></span><br><span class="line">    outb(PIC_S_DATA, <span class="number">0x02</span>); <span class="comment">// ICW3: 设置从片连接到主片的 IR2 引脚</span></span><br><span class="line">    outb(PIC_S_DATA, <span class="number">0x01</span>); <span class="comment">// ICW4: 8086 模式, 正常 EOI</span></span><br><span class="line">    <span class="comment">/*打开主片上 IR0,也就是目前只接受时钟产生的中断 */</span></span><br><span class="line">    outb(PIC_M_DATA, <span class="number">0xfe</span>);</span><br><span class="line">    outb(PIC_S_DATA, <span class="number">0xff</span>);</span><br><span class="line"></span><br><span class="line">    put_str(<span class="string">"pic_init done.\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*完成有关中断的所有初始化工作*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">idt_init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    put_str(<span class="string">"idt_init start.\n"</span>);</span><br><span class="line">    idt_desc_init();  <span class="comment">// 初始化中断描述符表</span></span><br><span class="line">    exception_handler_init();</span><br><span class="line">    pic_init();       <span class="comment">// 初始化 8259A</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载idt</span></span><br><span class="line">    <span class="keyword">uint64_t</span> idt_operand = ((<span class="keyword">sizeof</span>(idt) - <span class="number">1</span>) | ((<span class="keyword">uint64_t</span>) ((<span class="keyword">uint32_t</span>) idt &lt;&lt; <span class="number">16</span>)));</span><br><span class="line">    <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span> <span class="params">(<span class="string">"lidt %0"</span> : : <span class="string">"m"</span> (idt_operand))</span></span>;</span><br><span class="line">    put_str(<span class="string">"idt_init done.\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>kernel.S</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">[bits 32]</span><br><span class="line"></span><br><span class="line">; 对于CPU会自动压入错误码的中断类型，无需额外的操作</span><br><span class="line">%define ERROR_CODE nop</span><br><span class="line">; 如果CPU没有压入错误码，为了保持处理逻辑的一致性，我们需要手动压入一个0</span><br><span class="line">%define ZERO push 0</span><br><span class="line"></span><br><span class="line">extern put_str</span><br><span class="line">; 中断处理函数数组</span><br><span class="line">extern idt_table</span><br><span class="line"></span><br><span class="line">section .data</span><br><span class="line">intr_str db &quot;interrupt occur!&quot;, 0xa, 0</span><br><span class="line">global intr_entry_table</span><br><span class="line">intr_entry_table:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">; 中断处理程序宏定义</span><br><span class="line">%macro VECTOR 2</span><br><span class="line">section .text</span><br><span class="line">intr%1entry: 		        ;每个中断处理程序都要压入中断向量号</span><br><span class="line">                             ;所以一个中断类型一个中断处理程序</span><br><span class="line">                             ;自己知道自己的中断向量号是多少</span><br><span class="line">    </span><br><span class="line">    %2</span><br><span class="line">    ; 保存上下文</span><br><span class="line">    push ds</span><br><span class="line">    push es</span><br><span class="line">    push fs</span><br><span class="line">    push gs</span><br><span class="line">    pushad</span><br><span class="line"></span><br><span class="line">    mov al, 0x20  ;中断结束命令 EOI</span><br><span class="line">    out 0xa0, al  ;向从片发送</span><br><span class="line">    out 0x20, al  ;向主片发送</span><br><span class="line"></span><br><span class="line">    push %1</span><br><span class="line"></span><br><span class="line">    ; 调用C的中断处理函数</span><br><span class="line">    call [idt_table + 4 * %1]</span><br><span class="line">    jmp intr_exit</span><br><span class="line"></span><br><span class="line">section .data</span><br><span class="line">    dd intr%1entry</span><br><span class="line"></span><br><span class="line">%endmacro</span><br><span class="line"></span><br><span class="line">section .text</span><br><span class="line">global intr_exit</span><br><span class="line">intr_exit:</span><br><span class="line">    add esp, 4</span><br><span class="line">    popad</span><br><span class="line">    pop gs</span><br><span class="line">    pop fs</span><br><span class="line">    pop es</span><br><span class="line">    pop ds</span><br><span class="line">    add esp, 4</span><br><span class="line">    iretd</span><br><span class="line"></span><br><span class="line">VECTOR 0x00, ZERO</span><br><span class="line">VECTOR 0x01, ZERO</span><br><span class="line">VECTOR 0x02, ZERO</span><br><span class="line">VECTOR 0x03, ZERO</span><br><span class="line">VECTOR 0x04, ZERO</span><br><span class="line">VECTOR 0x05, ZERO</span><br><span class="line">VECTOR 0x06, ZERO</span><br><span class="line">VECTOR 0x07, ZERO</span><br><span class="line">VECTOR 0x08, ZERO</span><br><span class="line">VECTOR 0x09, ZERO</span><br><span class="line">VECTOR 0x0a, ZERO</span><br><span class="line">VECTOR 0x0b, ZERO</span><br><span class="line">VECTOR 0x0c, ZERO</span><br><span class="line">VECTOR 0x0d, ZERO</span><br><span class="line">VECTOR 0x0e, ZERO</span><br><span class="line">VECTOR 0x0f, ZERO</span><br><span class="line">VECTOR 0x10, ZERO</span><br><span class="line">VECTOR 0x11, ZERO</span><br><span class="line">VECTOR 0x12, ZERO</span><br><span class="line">VECTOR 0x13, ZERO</span><br><span class="line">VECTOR 0x14, ZERO</span><br><span class="line">VECTOR 0x15, ZERO</span><br><span class="line">VECTOR 0x16, ZERO</span><br><span class="line">VECTOR 0x17, ZERO</span><br><span class="line">VECTOR 0x18, ZERO</span><br><span class="line">VECTOR 0x19, ZERO</span><br><span class="line">VECTOR 0x1a, ZERO</span><br><span class="line">VECTOR 0x1b, ZERO</span><br><span class="line">VECTOR 0x1c, ZERO</span><br><span class="line">VECTOR 0x1d, ZERO</span><br><span class="line">VECTOR 0x1e, ERROR_CODE</span><br><span class="line">VECTOR 0x1f, ZERO</span><br><span class="line">VECTOR 0x20, ZERO</span><br></pre></td></tr></table></figure>

<p>编译如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;编译c程序，生成目标文件，这里需要关闭栈保护并指定32位程序</span><br><span class="line">sudo gcc -m32 -fno-stack-protector -I lib&#x2F;kernel -I lib&#x2F; -I kernel -c -fno-builtin -o build&#x2F;init.o kernel&#x2F;init.c </span><br><span class="line">sudo gcc -m32 -fno-stack-protector -I lib&#x2F;kernel -I lib&#x2F; -I kernel -c -fno-builtin -o build&#x2F;main.o kernel&#x2F;main.c</span><br><span class="line">sudo gcc -m32 -fno-stack-protector -I lib&#x2F;kernel -I lib&#x2F; -I kernel -c -fno-builtin -o build&#x2F;interrupt.o kernel&#x2F;interrupt.c</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;编译汇编</span><br><span class="line">sudo nasm -f elf -o build&#x2F;print.o lib&#x2F;kernel&#x2F;print.S</span><br><span class="line">sudo nasm -f elf -o build&#x2F;kernel.o kernel&#x2F;kernel.S</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;链接</span><br><span class="line">sudo ld -m elf_i386 -Ttext 0xc0001500 -e main -o build&#x2F;kernel.bin build&#x2F;main.o build&#x2F;init.o build&#x2F;interrupt.o build&#x2F;print.o build&#x2F;kernel.o</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;写入img</span><br><span class="line">&#x2F;&#x2F;sudo dd if&#x3D;build&#x2F;kernel.bin of&#x3D;&#x2F;home&#x2F;fyz&#x2F;sc&#x2F;bochs-2.6.2&#x2F;hd60M.img bs&#x3D;512 count&#x3D;200 seek&#x3D;9 conv&#x3D;notrunc</span><br><span class="line">sudo dd if&#x3D;.&#x2F;kernel.bin of&#x3D;&#x2F;home&#x2F;fyz&#x2F;sc&#x2F;bochs-2.6.2&#x2F;hd60M.img bs&#x3D;512 count&#x3D;200 seek&#x3D;9 conv&#x3D;notrunc</span><br><span class="line"></span><br><span class="line">sudo bin&#x2F;bochs -f bochsrc.disk</span><br></pre></td></tr></table></figure>

<p>运行结果 </p>
<p><img src="https://inews.gtimg.com/newsapp_ls/0/13190603501/0" alt="image-20210221033310276"> </p>
<h2 id="定时器-8253"><a href="#定时器-8253" class="headerlink" title="定时器 8253"></a>定时器 8253</h2><p>时钟表示的是设备运行的频率，工作节拍</p>
<blockquote>
<p><strong>内部时钟</strong>：由晶体振荡器产生，内部硬件固定设置好的，无法改变（ns级别）</p>
<p>外频：由内部时钟频率经过分频就是主板的外频，用于CPU和南北桥的通信</p>
<p>主频：外频×倍频，处理器取指令、执行指令的频率</p>
<p><strong>外部时钟</strong>：CPU与外设（接在南桥上）之间通信的时钟（ms或s级别）</p>
<p>要处理外部和内部两个不同时钟的设备能够同步通信，有两个方法：</p>
<ol>
<li>在软件上设定循环计时器，但白白占用CPU运算资源，不采用</li>
<li>在硬件上可以用到定时器来给内部时钟分频产生外部时钟，独立于CPU运行，提升cpu资源利用率，采用</li>
</ol>
</blockquote>
<p>例 <code>main.c</code> </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> cycle_cnt = <span class="number">90000</span>; </span><br><span class="line"><span class="keyword">while</span>(cycle_cnt-- &gt; <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>这个例子是让处理器执行 9 万次空循环，通过这种延迟方式达到一定的定时作用，但这种空兜处理器的代价是白白消耗时钟周期，处理器的资源是很宝贵的，可不能随意浪费。</p>
<p>8253 内部有 3 个独立的计数器 它们的端口分别是 0x40～0x42</p>
<p><img src="https://inews.gtimg.com/newsapp_ls/0/13190603516/0" alt="image-20210221045652176"> </p>
<p>寄存器资源包括一个 16 位的计数初值寄存器、一个计数器执行部件和一个输出锁存器。</p>
<p><img src="https://inews.gtimg.com/newsapp_ls/0/13190603530/0" alt="image-20210221045808130"> </p>
<p>每个计数器都有三个引脚：CLK，GATE，OUT。</p>
<blockquote>
<ol>
<li><p>CLK 表示时钟输入信号，即计数器自己工作的节拍，也就是计数器自己的时钟频率。每当此引脚收到一个时钟信号，减法计数器就将计数值减1。连接到此引脚的脉冲频率最高为10MHz，8253为2MHz。 </p>
</li>
<li><p>GATE 表示门控输入信号，在某些工作方式下用于控制计数器是否可以开始计数，在不同工作方式下 GATE 的作用不同，到时候同工作方式一同介绍。</p>
</li>
<li><p>OUT 表示计数器输出信号。当定时工作结束，也就是计数值为 0 时，根据计数器的工作方式，会在 OUT 引脚上输出相应的信号。此信号用来通知处理器或某个设备：定时完成。这样处理器或外部设备便可以执行相应的行为动作。</p>
</li>
</ol>
</blockquote>
<p> <img src="https://inews.gtimg.com/newsapp_ls/0/13190603547/0" alt="image-20210221045932530"> </p>
<p>8253控制寄存器的端口为0x43，是一个8位寄存器</p>
<p><img src="https://inews.gtimg.com/newsapp_ls/0/13190603565/0" alt="image-20210221050042830"> </p>
<p>RW1 和 RW0 位是读/写/锁存操作位，即Read/Write/Latch，用来设置待操作计数器（通道）的读写及锁存方式。</p>
<p>M2～M0 这三位是工作方式（模式）选择位，即 Method 或 Mode。</p>
<p>工作方式：</p>
<p><img src="https://inews.gtimg.com/newsapp_ls/0/13190603576/0" alt="image-20210221050246361"> </p>
<p>工作模式：</p>
<p><img src="https://inews.gtimg.com/newsapp_ls/0/13190603582/0" alt="image-20210221050908349"> </p>
<p>初始化 8253 的步骤：</p>
<blockquote>
<p>1．往控制字寄存器端口 0x43 中写入控制字</p>
<p>2．在所指定使用的计数器端口中写入计数初值</p>
</blockquote>
<h3 id="timer"><a href="#timer" class="headerlink" title="timer"></a>timer</h3><p><code>timer.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">"io.h"</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> print.h<span class="meta-string">"</span></span></span><br><span class="line"><span class="meta"><span class="meta-string"></span></span></span><br><span class="line"><span class="meta"><span class="meta-string"># define IRQ0_FREQUENCY 1000</span></span></span><br><span class="line"><span class="meta"><span class="meta-string"># define INPUT_FREQUENCY 1193180</span></span></span><br><span class="line"><span class="meta"><span class="meta-string"># define COUNTER0_VALUE INPUT_FREQUENCY / IRQ0_FREQUENCY</span></span></span><br><span class="line"><span class="meta"><span class="meta-string"># define COUNTER0_PORT 0x40</span></span></span><br><span class="line"><span class="meta"><span class="meta-string"># define COUNTER_MODE 2</span></span></span><br><span class="line"><span class="meta"><span class="meta-string"># define COUNTER0_NO 0</span></span></span><br><span class="line"><span class="meta"><span class="meta-string"># define READ_WRITE_LATCH 3</span></span></span><br><span class="line"><span class="meta"><span class="meta-string"># define PIT_CONTROL_PORT 0x43</span></span></span><br><span class="line"><span class="meta"><span class="meta-string"></span></span></span><br><span class="line"><span class="meta"><span class="meta-string">/* 把操作的计数器 counter_no､ 读写锁属性 rwl､ 计数器模式</span></span></span><br><span class="line"><span class="meta"><span class="meta-string"> counter_mode 写入模式控制寄存器并赋予初始值 counter_value */</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">static void frequency_set(uint8_t counter_port,</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">                          uint8_t counter_no,</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">                          uint8_t rwl,</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">                          uint8_t counter_mode,</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">                          uint16_t counter_value) &#123;</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">     /* 往控制字寄存器端口 0x43 中写入控制字 */</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">    outb(PIT_CONTROL_PORT, (uint8_t) (counter_no &lt;&lt; 6 | rwl &lt;&lt; 4 | counter_mode &lt;&lt; 1));</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">    /* 先写入 counter_value 的低 8 位 */</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">    outb(counter_port, (uint8_t) counter_value);</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">    /* 先写入 counter_value 的高 8 位 */</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">    outb(counter_port, (uint8_t) counter_value &gt;&gt; 8);</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">&#125;</span></span></span><br><span class="line"><span class="meta"><span class="meta-string"></span></span></span><br><span class="line"><span class="meta"><span class="meta-string">/**</span></span></span><br><span class="line"><span class="meta"><span class="meta-string"> * 初始化PIT 8253.</span></span></span><br><span class="line"><span class="meta"><span class="meta-string"> */ </span></span></span><br><span class="line"><span class="meta"><span class="meta-string">void timer_init() &#123;</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">    put_str("</span>timer_init start.\n<span class="meta-string">");</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">    /* 设置 8253 的定时周期，也就是发中断的周期 */</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">    frequency_set(COUNTER0_PORT, COUNTER0_NO, READ_WRITE_LATCH, COUNTER_MODE, COUNTER0_VALUE);</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">    put_str("</span>timer_init done.\n<span class="meta-string">");</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">&#125;</span></span></span><br></pre></td></tr></table></figure>

<p><code>timer.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">timer_init</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>timer_init 函数加在文件 init.c 。</p>
<p><code>init.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">"init.h"</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">"print.h"</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">"timer.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_all</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    put_str(<span class="string">"init_all.\n"</span>);</span><br><span class="line">    idt_init();</span><br><span class="line">    timer_init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当前目录如下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── boot</span><br><span class="line">│   ├── include</span><br><span class="line">│   │   └── boot.inc</span><br><span class="line">│   ├── loader.bin</span><br><span class="line">│   ├── loader.S</span><br><span class="line">│   ├── mbr.bin</span><br><span class="line">│   └── mbr.S</span><br><span class="line">├── build</span><br><span class="line">│   ├── init.o</span><br><span class="line">│   ├── interrupt.o</span><br><span class="line">│   ├── kernel.bin</span><br><span class="line">│   ├── kernel.o</span><br><span class="line">│   ├── main.o</span><br><span class="line">│   ├── print.o</span><br><span class="line">│   └── timer.o</span><br><span class="line">├── device</span><br><span class="line">│   ├── timer.c</span><br><span class="line">│   └── timer.h</span><br><span class="line">├── kernel</span><br><span class="line">│   ├── global.h</span><br><span class="line">│   ├── init.c</span><br><span class="line">│   ├── init.h</span><br><span class="line">│   ├── interrupt.c</span><br><span class="line">│   ├── interrupt.h</span><br><span class="line">│   ├── kernel.S</span><br><span class="line">│   └── main.c</span><br><span class="line">└── lib</span><br><span class="line">    ├── kernel</span><br><span class="line">    │   ├── io.h</span><br><span class="line">    │   ├── print.h</span><br><span class="line">    │   ├── print.o</span><br><span class="line">    │   └── print.S</span><br><span class="line">    ├── stdint.h</span><br><span class="line">    └── user</span><br></pre></td></tr></table></figure>

<p>编译如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;编译c程序，生成目标文件，这里需要关闭栈保护并指定32位程序</span><br><span class="line">sudo gcc -m32 -fno-stack-protector -I lib&#x2F;kernel -I lib&#x2F; -I kernel -c -fno-builtin -o build&#x2F;init.o kernel&#x2F;init.c </span><br><span class="line">sudo gcc -m32 -fno-stack-protector -I lib&#x2F;kernel -I lib&#x2F; -I kernel -c -fno-builtin -o build&#x2F;main.o kernel&#x2F;main.c</span><br><span class="line">sudo gcc -m32 -fno-stack-protector -I lib&#x2F;kernel -I lib&#x2F; -I kernel -c -fno-builtin -o build&#x2F;interrupt.o kernel&#x2F;interrupt.c</span><br><span class="line">sudo gcc -m32 -fno-stack-protector -I lib&#x2F;kernel -c -o build&#x2F;timer.o device&#x2F;timer.c</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;编译汇编</span><br><span class="line">sudo nasm -f elf -o build&#x2F;print.o lib&#x2F;kernel&#x2F;print.S</span><br><span class="line">sudo nasm -f elf -o build&#x2F;kernel.o kernel&#x2F;kernel.S</span><br><span class="line">sudo nasm -f elf -o build&#x2F;kernel.o kernel&#x2F;kernel.S</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;链接</span><br><span class="line">sudo ld -m elf_i386 -Ttext 0xc0001500 -e main -o build&#x2F;kernel.bin build&#x2F;main.o build&#x2F;init.o build&#x2F;interrupt.o build&#x2F;print.o build&#x2F;kernel.o  build&#x2F;timer.o</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;写入img</span><br><span class="line">&#x2F;&#x2F;sudo dd if&#x3D;build&#x2F;kernel.bin of&#x3D;&#x2F;home&#x2F;fyz&#x2F;sc&#x2F;bochs-2.6.2&#x2F;hd60M.img bs&#x3D;512 count&#x3D;200 seek&#x3D;9 conv&#x3D;notrunc</span><br><span class="line">sudo dd if&#x3D;.&#x2F;kernel.bin of&#x3D;&#x2F;home&#x2F;fyz&#x2F;sc&#x2F;bochs-2.6.2&#x2F;hd60M.img bs&#x3D;512 count&#x3D;200 seek&#x3D;9 conv&#x3D;notrunc</span><br><span class="line"></span><br><span class="line">sudo bin&#x2F;bochs -f bochsrc.disk</span><br></pre></td></tr></table></figure>

<p>运行结果 </p>
<p><img src="https://inews.gtimg.com/newsapp_ls/0/13190603602/0" alt="image-20210221054859824"> </p>

      
      <!-- reward -->
      
      <div id="reward-btn">
        Reward
      </div>
      
    </div>
    
    
      <!-- copyright -->
      
        <div class="declare">
          <ul class="post-copyright">
            <li>
              <i class="ri-copyright-line"></i>
              <strong>Copyright： </strong>
              Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source.
            </li>
          </ul>
        </div>
        
    <footer class="article-footer">
      
          
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://yoursite.com/2021/02/21/cx5/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9C%9F%E8%B1%A1%E8%BF%98%E5%8E%9F/" rel="tag">操作系统真象还原</a></li></ul>


    </footer>

  </div>

  
  
  <nav class="article-nav">
    
      <a href="/2021/02/21/cx4/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            操作系统真象还原&lt;第四部分&gt;
          
        </div>
      </a>
    
    
      <a href="/2021/02/21/cx3/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">操作系统真象还原&lt;第三部分&gt;</div>
      </a>
    
  </nav>


  

  
  
<!-- valine评论 -->
<div id="vcomments-box">
    <div id="vcomments">
    </div>
</div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: '',
        app_key: '',
        path: window.location.pathname,
        notify: 'false',
        verify: 'false',
        avatar: 'mp',
        placeholder: '给我的文章加点评论吧~',
        recordIP: true
    });
    const infoEle = document.querySelector('#vcomments .info');
    if (infoEle && infoEle.childNodes && infoEle.childNodes.length > 0) {
        infoEle.childNodes.forEach(function (item) {
            item.parentNode.removeChild(item);
        });
    }
</script>
<style>
    #vcomments-box {
        padding: 5px 30px;
    }

    @media screen and (max-width: 800px) {
        #vcomments-box {
            padding: 5px 0px;
        }
    }

    #vcomments-box #vcomments {
        background-color: #fff;
    }

    .v .vlist .vcard .vh {
        padding-right: 20px;
    }

    .v .vlist .vcard {
        padding-left: 10px;
    }
</style>

  

  
  
  

</article>
</section>
      <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>
        &copy;
        2015-2021
        John Doe
      </li>
      <li>
        
        Powered by
        
        
        <a href="https://hexo.io" target="_blank">Hexo</a> Theme <a href="https://github.com/Shen-Yu/hexo-theme-ayer" target="_blank">Ayer</a>
        
      </li>
    </ul>
    <ul class="list-inline">
      <li>
        
        
        <span>
  <i>PV:<span id="busuanzi_value_page_pv"></span></i>
  <i>UV:<span id="busuanzi_value_site_uv"></span></i>
</span>
        
      </li>
      
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="Hexo"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Search">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script>
  try {
    var typed = new Typed("#subtitle", {
      strings: ['你努力，剩下的交给我', '愿你一生努力，一生被爱', '想要的都拥有，得不到的都释怀'],
      startDelay: 0,
      typeSpeed: 200,
      loop: true,
      backSpeed: 100,
      showCursor: true
    });
  } catch (err) {
  }

</script>




<script src="/js/tocbot.min.js"></script>

<script>
  // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: 'main',
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto'
  });
</script>



<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>



<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>





<script src="/js/busuanzi-2.3.pure.min.js"></script>



<script type="text/javascript" src="https://js.users.51.la/20544303.js"></script>


    
  </div>
</body>

</html>